# === Stage 1: Build everything in one stage ===
FROM gradle:9.0.0-jdk21-alpine AS build
WORKDIR /workspace

# Copy Common module first
COPY Common ./Common

# Copy microservice
COPY Solicitudes ./Solicitudes

# Build Common and then microservice
RUN cd Common && \
    ./gradlew publishToMavenLocal --no-daemon --quiet --parallel -x test && \
    cd ../Solicitudes && \
    ./gradlew bootJar --no-daemon --quiet --parallel -x test && \
    find . -name "*.jar" -not -path "*/build/libs/*" -delete

# === Stage 2: Ultra-minimal runtime ===
FROM gcr.io/distroless/java21-debian12:nonroot
WORKDIR /app

# Copy only the final JAR
COPY --from=build /workspace/Solicitudes/applications/app-service/build/libs/*.jar ./solicitudes.jar

# Use non-root user for security
USER nonroot:nonroot

# Optimized JVM settings for containers
EXPOSE 8081
ENTRYPOINT ["java", \
    "-XX:+UseContainerSupport", \
    "-XX:MaxRAMPercentage=75.0", \
    "-XX:+UseG1GC", \
    "-XX:+UseStringDeduplication", \
    "-Djava.security.egd=file:/dev/./urandom", \
    "-jar", "/app/solicitudes.jar"]